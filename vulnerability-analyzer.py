import os
import csv
import subprocess
import json

def run_grype(repo_path):
    result = subprocess.run(['grype', repo_path, '-o', 'json'], capture_output=True, text=True)
    return result.stdout

def parse_grype_output(output, repo_name):
    data = json.loads(output)
    vulnerabilities = []
    for match in data.get('matches', []):
        vuln = match['vulnerability']
        artifact = match['artifact']
        
        # Extraer el valor de FIXED-IN
        fixed_in = 'N/A'
        if 'fix' in vuln and 'versions' in vuln['fix']:
            # Asumimos que solo queremos la primera versi√≥n si hay varias
            fixed_in = vuln['fix']['versions'][0] if vuln['fix']['versions'] else 'N/A'
        
        vulnerabilities.append([
            repo_name,
            artifact['name'],                  # NAME Vulnerabilidad
            artifact.get('version', 'N/A'),    # INSTALLED
            fixed_in,                          # FIXED-IN
            artifact['type'],                  # TYPE
            vuln['id'],                        # VULNERABILITY
            vuln['severity']                   # SEVERITY
        ])
    return vulnerabilities

def main(folder_path, output_csv):
    all_vulnerabilities = []
    for repo_name in os.listdir(folder_path):
        repo_path = os.path.join(folder_path, repo_name)
        if os.path.isdir(repo_path):
            print(f"Analizando {repo_name}...")
            grype_output = run_grype(repo_path)
            vulnerabilities = parse_grype_output(grype_output, repo_name)
            all_vulnerabilities.extend(vulnerabilities)

    with open(output_csv, mode='w', newline='') as file:
        writer = csv.writer(file)
        writer.writerow(['REPO NAME', 'NAME Vulnerabilidad', 'INSTALLED', 'FIXED-IN', 'TYPE', 'VULNERABILITY', 'SEVERITY'])
        writer.writerows(all_vulnerabilities)

if __name__ == "__main__":
    folder_path = input("Introduce la ruta de la carpeta con los repositorios: ")
    output_csv = input("Introduce el nombre del archivo CSV de salida: ")
    main(folder_path, output_csv)
